name: Build

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: "å¯ç”¨ tmate è¿œç¨‹è°ƒè¯•"
        required: false
        default: false

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  DEPENDENCIES_FILE: n1/dependencies
  FILES: n1/files
  CONFIG_FILE: n1/.config
  DIY_SH: n1/diy.sh
  KERNEL_VER: 6.12.y
  PACKAGE_SCRIPT: n1/mk_s905d_n1.sh
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v6

      - name: æ¸…ç†ç£ç›˜é‡Šæ”¾ç©ºé—´
        uses: BRAINSia/free-disk-space@v2
        with:
          docker-images: false

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(<"$DEPENDENCIES_FILE")
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown "$USER":"$GROUPS" /workdir

      - name: å…‹éš†æºç 
        working-directory: /workdir
        run: |
          git clone -b "$REPO_BRANCH" --depth=1 --single-branch "$REPO_URL" immortalwrt
          ln -sf /workdir/immortalwrt "$GITHUB_WORKSPACE/immortalwrt"

      - name: æ›´æ–°è½¯ä»¶æº
        working-directory: ./immortalwrt
        run: |
          ./scripts/feeds update -a

      - name: å®‰è£…è½¯ä»¶æº
        working-directory: ./immortalwrt
        run: |
          ./scripts/feeds install -a

      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          [[ -d "$FILES" ]] && mv -f "$FILES" immortalwrt/files
          [[ -f "$CONFIG_FILE" ]] && mv -f "$CONFIG_FILE" immortalwrt/.config
          [[ ! -x "$DIY_SH" ]] && chmod +x "$DIY_SH"
          cd immortalwrt
          "$GITHUB_WORKSPACE/$DIY_SH"

      - name: å¼€å¯ tmate è¿œç¨‹è°ƒè¯•ä¼šè¯
        if: github.event_name == 'workflow_dispatch' && inputs.debug_enabled
        uses: mxschmitt/action-tmate@v3

      - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…
        working-directory: ./immortalwrt
        run: |
          echo -e "$(nproc) thread compile"
          make defconfig
          make download -j"$(nproc)"
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        working-directory: ./immortalwrt
        run: |
          make -j"$(nproc)" || make -j1 || make -j1 V=s
          echo "compile_status=success" >>"$GITHUB_ENV"
          echo "RELEASE_NAME=$(date +"%Y-%m-%d %H:%M:%S")" >>"$GITHUB_ENV"
          echo "RELEASE_TAG=$(date +"%Y%m%d%H%M%S")" >>"$GITHUB_ENV"
          echo "BUILD_TIME=$(date +"%Yå¹´%mæœˆ%dæ—¥ %Hæ—¶%Måˆ†%Sç§’")" >>"$GITHUB_ENV"

      - name: ä¸Šä¼  ImmortalWrt ç¼–è¯‘æ–‡ä»¶
        if: env.compile_status == 'success'
        uses: actions/upload-artifact@v6
        with:
          name: immortalwrt_${{ env.RELEASE_TAG }}
          path: immortalwrt/bin

      - name: æ‰“åŒ… ImmortalWrt å›ºä»¶
        if: env.compile_status == 'success'
        uses: unifreq/openwrt_packit@master
        env:
          OPENWRT_ARMSR: immortalwrt/bin/targets/*/*/*rootfs.tar.gz
          KERNEL_VERSION_NAME: ${{ env.KERNEL_VER }}
          PACKAGE_SOC: diy
          GZIP_IMGS: .xz
          SCRIPT_DIY_PATH: ${{ env.PACKAGE_SCRIPT }}
          WHOAMI: ${{ github.repository_owner }}
          SW_FLOWOFFLOAD: 0
          SFE_FLOW: 0
          ENABLE_WIFI_K510: 0
          DISTRIB_DESCRIPTION: ImmortalWrt

      - name: ä¸Šä¼ å›ºä»¶è‡³ GitHub Release
        if: env.PACKAGED_STATUS == 'success'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.PACKAGED_OUTPUTPATH }}/*.img.xz
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ env.RELEASE_TAG }}
          body: |
            ### ğŸ“¦ å›ºä»¶ä¿¡æ¯
            - ğŸ’» **æœºå‹**: æ–è®¯N1 ( Amlogic S905D )
            - ğŸŒ³ **æºç **: [immortalwrt/immortalwrt](${{ env.REPO_URL }})
            - ğŸŒ¿ **åˆ†æ”¯**: `${{ env.REPO_BRANCH }}`
            - ğŸ“… **ç¼–è¯‘æ—¶é—´**: ${{ env.BUILD_TIME }}
            - ğŸŒ **é»˜è®¤åœ°å€**: `192.168.1.1`
            - ğŸ‘¤ **é»˜è®¤ç”¨æˆ·**: `root`
            - ğŸ”’ **é»˜è®¤å¯†ç **: `password`

            ---
            - âš ï¸ **æ³¨æ„äº‹é¡¹**: é¦–æ¬¡ä½¿ç”¨å»ºè®®å…¨æ–°åˆ·å†™

      - name: å‘é€æ„å»ºç»“æœè‡³ Telegram
        uses: appleboy/telegram-action@v1.0.1
        if: always()
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: html
          message: |
            <b>ğŸš€ ImmortalWrt æ„å»ºæŠ¥å‘Š</b>

            ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}

            <b>ğŸ“¦ é¡¹ç›®ä¿¡æ¯</b>
            ä»“åº“ï¼š<code>${{ github.repository }}</code>
            åˆ†æ”¯ï¼š<code>${{ github.ref_name }}</code>
            ç¼–å·ï¼š<code>${{ github.run_number }}</code>

            <b>ğŸ‘¤ è§¦å‘ä¿¡æ¯</b>
            è´¦å·ï¼š<code>${{ github.actor }}</code>
            è§¦å‘ï¼š<code>${{ github.event_name }}</code>
            å“ˆå¸Œï¼š<code>${{ github.sha }}</code>

            <b>ğŸ”— å¿«é€Ÿé“¾æ¥</b>
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">ğŸ“‹ æŸ¥çœ‹å®Œæ•´æ—¥å¿—</a>
            <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">ğŸ’» æŸ¥çœ‹ä»£ç å˜æ›´</a>
